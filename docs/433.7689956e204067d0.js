"use strict";(self.webpackChunkpyramid=self.webpackChunkpyramid||[]).push([[433],{433:(X,B,s)=>{s.r(B),s.d(B,{CreateItemsModule:()=>K});var T=s(9808),P=s(6037),C=s(9600),N=s(7577),D=s(9028),J=s(4499),m=s(5861),k=s(655),u=s(2382),g=s(4987),S=s(1169);let U=(()=>{class r extends S.e{constructor(n){super(),this.wells=[],Object.assign(this,n)}}return r.tableName="Containers",r})(),$=(()=>{class r extends S.e{constructor(n){super(),this.wellContents=[],Object.assign(this,n)}}return r.tableName="Wells",r})();var F=s(7489),b=s(3120),v=(()=>{return(r=v||(v={}))[r.Unknown=0]="Unknown",r[r.Zebra200=2]="Zebra200",r[r.Zebra300=3]="Zebra300",r[r.Zebra600=6]="Zebra600",v;var r})(),p=(()=>{return(r=p||(p={}))[r.None=0]="None",r[r.Text=1]="Text",r[r.Barcode39=2]="Barcode39",r[r.Barcode128=3]="Barcode128",p;var r})(),Y=s(1764);class E{constructor(e,n,o,i){if(this.fields=[],this.resolution=300,this.dx=0,this.dy=0,this.fw=0,1==e){this.addBarcode128(i[0],65,65,180),this.addText(null!=o?o:e.toString(),825,200,90);for(let l=0;l<i.length;l++)this.addText(i[l],700-125*l,200,90);const a=Y().format("YYYY/MM/DD HH:mm");this.addText(a,75,200,90)}else if(2==e){if(0==i.length)throw new Error("Plate Label: barcode required");this.addText(o,100,310,270),this.addBarcode128(i[0],95,40,270),i.length>1&&this.addText(i[1],40,310,270)}}addBarcode39(e,n,o,i){this.fields.push(new Z(p.Barcode39,e,n,o,i))}addBarcode128(e,n,o,i){this.fields.push(new Z(p.Barcode128,e,n,o,i))}addText(e,n,o,i){this.fields.push(new Z(p.Text,e,n,o,i))}printLabel(e){const n=this.getZPLCode();console.log(n)}getZPLCode(){let e="^XA";return e+=`^LH${y(this.resolution,this.dx,this.dy)}`,e+="^BY3,,100",e+=`~SD${this.fw}`,this.fields.forEach(n=>e+=n.getZPLCode(this.resolution)),e+="^XZ",e}}class Z{constructor(e,n,o,i,a){this.dir={0:"N",90:"R",180:"I",270:"B"},this.font="0",this.rotation=0,this.fieldType=e,this.text=n,this.x=o,this.y=i,this.rotation=a}getZPLCode(e){var n;const o=this.dir[this.rotation],i=y(e,null!==(n=this.ht)&&void 0!==n?n:80);let a="^FO"+y(e,this.x,this.y);return this.fieldType==p.Text?a+="^A"+this.font+o+","+i:this.fieldType==p.Barcode39?a+="^B3"+o+",N,"+i+",Y,N":this.fieldType==p.Barcode128&&(a+="^BC"+o+","+i+",Y,N,N"),a+=`^FD${this.text}^FS`,a}}function y(r,e,n=-1){const o=(e*r/1e3).toFixed(0);return n<0?o:`${o},${(n*r/1e3).toFixed(0)}`}var L=s(9783),t=s(5e3),w=s(1528),A=s(845),z=s(9114),M=s(9748),Q=s(7010),W=s(1424),R=s(7773),O=s(9711);function j(r,e){if(1&r){const n=t.EpF();t.TgZ(0,"div",26)(1,"button",27),t.NdJ("click",function(){t.CHM(n);const i=t.oxw();return t.KtG(i.cancel())}),t.qZA(),t.TgZ(2,"p-button",28),t.NdJ("click",function(){t.CHM(n);const i=t.oxw();return t.KtG(i.create())}),t.qZA()()}}const H=function(){return{width:"50vw",minWidth:"400px",maxWidth:"600px"}};let h=class{constructor(e,n,o,i,a,l){this.pyramid=e,this.store=n,this.biz=o,this.fb=i,this.ns=a,this.ms=l,this.picklists=null,this.containerDefs=[],this.theList=null,this.itemSets=[],this.msgs=[],this.cols=[{field:"barcode",header:"Barcode",render:c=>this.biz.toBarcode(c.barcode)},{field:"part",header:"Part",render:c=>`${c.picklist.name}.${c.option.name}`},{field:"count",header:"Count"},{field:"title",header:"Title"},{field:"details1",header:"Details"},{field:"details2",header:"Details"},{field:"format",header:"Format",render:c=>{var d;return null===(d=c.format)||void 0===d?void 0:d.name}},{field:"printer",header:"Printer",render:c=>{var d;return null===(d=c.printer)||void 0===d?void 0:d.name}},{type:"icon",field:"icon_delete",icon:"delete",wd:30,click:(c,d)=>this.onClick(c,d)}]}ngOnInit(){var e=this;return(0,m.Z)(function*(){e.store.profile$.pipe((0,g.t)(e)).subscribe(n=>e.profile=n),e.store.picklists$.pipe((0,g.t)(e)).subscribe(n=>e.picklists=n),e.form=e.fb.group({picklist:[null,[u.kI.required]],option:[null,[u.kI.required]],count:[1,[...b.Jr.Range(1,1e3,!0)]],title:["PCR Plate",[...b.Jr.Text(30,!0)]],details1:["PRJ-01a5",[...b.Jr.Text(30,!1)]],details2:["BRCA",[...b.Jr.Text(30,!1)]],format:[null,[]],printer:[null,[]]}),e.containerDefs=yield e.pyramid.list("ContainerModels")})()}onClick(e,n){this.ns.message(`${n.count} labels removed from worklist`),this.itemSets=this.itemSets.filter(o=>o!=n)}addItems(){var e=this;return(0,m.Z)(function*(){if(!e.form.invalid){const n=e.form.value,o=Object.assign({barcode:yield e.biz.reserveBarcodes(n.count)},n);e.itemSets=[...e.itemSets,o],e.ns.message("ITEMS ADDED")}})()}create(){var e=this;return(0,m.Z)(function*(){const n=[];e.itemSets.forEach(i=>{const a=e.biz.fromBarcode(i.barcode);for(let l=0;l<i.count;l++)n.push({barcode:e.biz.toBarcode(a+l),picklist:i.picklist,option:i.option,title:i.title,data:[i.details1,i.details2],format:i.format,printer:i.printer})});const o=n.filter(i=>i.format&&i.printer);if(o.length>0)try{if((yield e.ns.confirm("Print Labels",1===o.length?"Do you want to print the label now?":`Do you want to print the ${o.length} labels now?`))&&(e.printLabels(o),!(yield e.ns.confirm("Print Labels",(1==o.length?"Now printing the label...":`Now printing ${o.length} labels...`)+`<br/><br/> Check the printer ... did the ${e.pl("label",o.length)} print correctly?`))))throw new Error}catch(i){yield e.ns.alert("Print Labels","Printing failed. Any labels that were printed should be discarded. The items have not been created. Check the printer problem and try again.")}finally{e.ns.close()}try{e.ns.message(`Creating ${n.length} new ${e.pl("item",n.length)}`),yield e.createItems(n),e.itemSets=[]}finally{setTimeout(()=>e.ns.close(),250)}})()}pl(e,n){return e+(1==n?"":"s")}printLabels(e){e.forEach(n=>{new E(1,n.barcode,n.name,n.data).printLabel(v.Zebra300)})}createItems(e){var n=this;return(0,m.Z)(function*(){try{n.groupBy(e,i=>i.picklist.key).forEach(function(){var i=(0,m.Z)(function*(a,l){l.startsWith("Container")?(yield n.createContainers(a),console.log("Containers created!")):l.startsWith("Instrument")||l.startWith("Location")||l.startWith("Holder")});return function(a,l){return i.apply(this,arguments)}}())}catch(o){n.ns.alert("Error",`Error creating containers:<br>${o.message}`)}})()}groupBy(e,n){const o=new Map;return e.forEach(i=>{const a=n(i),l=o.get(a);l?l.push(i):o.set(a,[i])}),o}createContainers(e){var n=this;return(0,m.Z)(function*(){const o=[],i=n.picklists;return(new Date).toISOString(),e.forEach(l=>{var c;const d=n.containerDefs.find(f=>f.containerType===l.option.id),x=new U({barcode:l.barcode,containerModelId:null!==(c=null==d?void 0:d.id)&&void 0!==c?c:0,containerState:i.idByKey("ContainerState|Created"),containerStatus:i.idByKey("ContainerStatus|Valid"),wells:[]});for(let f=0;f<(null==d?void 0:d.wellRows);f++)for(let I=0;I<(null==d?void 0:d.wellCols);I++)x.wells.push(new $({row:f,col:I,wellStatus:i.idByKey("WellStatus|Valid")}));console.log(`Saving container ${x.barcode}`),o.push(n.biz.saveContainer(x))}),Promise.all(o)})()}cancel(){var e=this;return(0,m.Z)(function*(){e.itemSets.length>0&&(yield e.ns.confirm("Clear Worklist","Are you sure you want to remove all worklist items?"))&&(e.itemSets.length=0)})()}removeItem(e){var n=this;return(0,m.Z)(function*(){F.remove(n.itemSets,e)})()}delay(e){return new Promise(n=>setTimeout(n,e))}};h.\u0275fac=function(e){return new(e||h)(t.Y36(w.tG),t.Y36(w.d6),t.Y36(w.Kc),t.Y36(u.QS),t.Y36(C.c),t.Y36(L.ez))},h.\u0275cmp=t.Xpm({type:h,selectors:[["app-create-labels"]],features:[t._Bn([L.YP,L.ez])],decls:45,vars:22,consts:[["position","center","key","c"],["rejectButtonStyleClass","p-button-outlined p-button-secondary","acceptButtonStyleClass","p-button-warning",3,"baseZIndex"],[1,"flex","flex-column"],[1,"card"],[3,"formGroup","ngSubmit"],[1,"formgrid","grid"],[1,"field","col-12","md:col-3","mt-1"],["for","picklist"],["inputId","picklist","formControlName","picklist","optionLabel","name","styleClass","w-full",3,"options","autoDisplayFirst","showClear","onChange"],["for","option"],["inputId","option","formControlName","option","optionLabel","name","styleClass","w-full",3,"options","autoDisplayFirst"],["for","count"],["inputId","count","formControlName","count","styleClass","w-full","mode","decimal",1,"w-full",3,"showButtons"],["for","title"],["id","title","formControlName","title","type","text","pInputText","",1,"w-full"],["for","details1"],["id","details1","formControlName","details1","type","text","pInputText","",1,"w-full"],["for","details2"],["id","details2","formControlName","details2","type","text","pInputText","",1,"w-full"],["inputId","format","formControlName","format","optionLabel","name","styleClass","w-full",3,"options","autoDisplayFirst","showClear"],["inputId","printer","formControlName","printer","optionLabel","name","styleClass","w-full",3,"options","autoDisplayFirst","showClear"],[1,"mt-3"],["label","Add to Worklist","icon","pi pi-sort-down","iconPos","right",3,"disabled","click"],[1,"card","p-0"],[3,"value","cols"],["class","flex mt-4 mb-2",4,"ngIf"],[1,"flex","mt-4","mb-2"],["pButton","","pRipple","","type","button","label","Clear",1,"p-button-text","ml-auto","mr-2",3,"click"],["label","Submit",1,"mr-2",3,"click"]],template:function(e,n){1&e&&(t._UZ(0,"p-toast",0)(1,"p-confirmDialog",1),t.TgZ(2,"div",2)(3,"div",3)(4,"form",4),t.NdJ("ngSubmit",function(){return n.addItems()}),t.TgZ(5,"div",5)(6,"div",6)(7,"label",7),t._uU(8,"Category"),t.qZA(),t.TgZ(9,"p-dropdown",8),t.NdJ("onChange",function(i){return n.theList=i.value}),t.qZA()(),t.TgZ(10,"div",6)(11,"label",9),t._uU(12),t.qZA(),t._UZ(13,"p-dropdown",10),t.qZA(),t.TgZ(14,"div",6)(15,"label",11),t._uU(16,"Quantity"),t.qZA(),t._UZ(17,"p-inputNumber",12),t.qZA()(),t.TgZ(18,"div",5)(19,"div",6)(20,"label",13),t._uU(21,"Title"),t.qZA(),t._UZ(22,"input",14),t.qZA(),t.TgZ(23,"div",6)(24,"label",15),t._uU(25,"Details"),t.qZA(),t._UZ(26,"input",16),t.qZA(),t.TgZ(27,"div",6)(28,"label",17),t._uU(29,"Details"),t.qZA(),t._UZ(30,"input",18),t.qZA()(),t.TgZ(31,"div",5)(32,"div",6)(33,"label",9),t._uU(34,"Label format"),t.qZA(),t._UZ(35,"p-dropdown",19),t.qZA(),t.TgZ(36,"div",6)(37,"label",9),t._uU(38,"Label printer"),t.qZA(),t._UZ(39,"p-dropdown",20),t.qZA()(),t.TgZ(40,"div",21)(41,"p-button",22),t.NdJ("click",function(){return n.addItems()}),t.qZA()()()(),t.TgZ(42,"div",23),t._UZ(43,"tbl",24),t.YNc(44,j,3,0,"div",25),t.qZA()()),2&e&&(t.xp6(1),t.Akn(t.DdM(21,H)),t.Q6J("baseZIndex",1e4),t.xp6(3),t.Q6J("formGroup",n.form),t.xp6(5),t.Q6J("options",null==n.picklists?null:n.picklists.canLabel)("autoDisplayFirst",!1)("showClear",!0),t.xp6(3),t.Oqu((null==n.theList?null:n.theList.name)||"Part"),t.xp6(1),t.Q6J("options",null==n.theList?null:n.theList.options)("autoDisplayFirst",!1),t.xp6(4),t.Q6J("showButtons",!0),t.xp6(18),t.Q6J("options",n.picklists.options("LabelFormat"))("autoDisplayFirst",!1)("showClear",!0),t.xp6(4),t.Q6J("options",n.picklists.options("Printer"))("autoDisplayFirst",!1)("showClear",!0),t.xp6(2),t.Q6J("disabled",n.form.invalid),t.xp6(2),t.Q6J("value",n.itemSets)("cols",n.cols),t.xp6(1),t.Q6J("ngIf",null==n.itemSets?null:n.itemSets.length))},dependencies:[T.O5,u._Y,u.Fj,u.JJ,u.JL,u.sg,u.u,A.Hq,A.zx,z.Q,M.Lt,Q.Rn,W.o,R.FN,O.$]}),h=(0,k.gn)([(0,g.c)()],h);const G=[{path:"",component:h,canActivate:[D.a1]}];let K=(()=>{class r{}return r.\u0275fac=function(n){return new(n||r)},r.\u0275mod=t.oAB({type:r}),r.\u0275inj=t.cJS({imports:[T.ez,J.m,P.Bz.forChild(G),C.cB,C.NY,N.R]}),r})()}}]);